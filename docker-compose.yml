version: '3.8'

# ============================================================
# Docker Compose for Customer Support MultiAgent System
# ============================================================
# Services:
#   - api: FastAPI application
#   - mongodb: MongoDB database
#   - telegram-bot: Telegram bot (polling mode for dev)
#   - dashboard: Streamlit dashboard
# ============================================================

services:
  # -------------------- MongoDB Database --------------------
  # mongodb:
  #   image: mongo:7.0
  #   container_name: customer-support-mongodb
  #   restart: unless-stopped
  #   environment:
  #     MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER:-admin}
  #     MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-changeme}
  #     MONGO_INITDB_DATABASE: ${DATABASE_NAME:-customer_support_esc}
  #   ports:
  #     - "${MONGO_PORT:-27017}:27017"
  #   volumes:
  #     - mongodb_data:/data/db
  #     - mongodb_config:/data/configdb
  #   networks:
  #     - customer-support-network
  #   healthcheck:
  #     test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #     start_period: 20s

  # -------------------- FastAPI Application --------------------
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: customer-support-api
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "${API_PORT:-8000}:8000"
    environment:
      API_HOST: ${API_HOST:-0.0.0.0}
      API_PORT: ${API_PORT:-8000}

    volumes:
      - ./chroma_db:/app/chroma_db
      - ./logs:/app/logs
      - ./scripts:/app/scripts

    networks:
      - customer-support-network

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # -------------------- Telegram Bot (Polling - Dev Only) --------------------
  telegram-bot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: customer-support-telegram-bot
    restart: unless-stopped
    env_file:
      - .env
    command: ["python", "run_telegram_bot.py"]
    environment:
      API_HOST: ${API_HOST:-0.0.0.0}
      API_PORT: ${API_PORT:-8000}

    volumes:
      - ./chroma_db:/app/chroma_db
      - ./logs:/app/logs

    depends_on:
      api:
        condition: service_healthy

    networks:
      - customer-support-network

    profiles:
      - dev
      - full

  # -------------------- Streamlit Dashboard --------------------
  dashboard:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: customer-support-dashboard
    restart: unless-stopped
    env_file:
      - .env
    command: ["streamlit", "run", "src/dashboard/app.py", "--server.port=8501", "--server.address=0.0.0.0"]
    ports:
      - "${DASHBOARD_PORT:-8501}:8501"

    volumes:
      - ./logs:/app/logs

    depends_on:
      api:
        condition: service_healthy

    networks:
      - customer-support-network

    profiles:
      - dev
      - full

# -------------------- Networks --------------------
networks:
  customer-support-network:
    driver: bridge
    name: customer-support-network

# -------------------- Volumes --------------------
volumes:
  mongodb_data:
    name: customer-support-mongodb-data
    driver: local

  # mongodb_config:
  #   name: customer-support-mongodb-config
  #   driver: local
