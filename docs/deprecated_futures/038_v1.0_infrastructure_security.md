# Infrastructure Security

> **Versão Target:** V1.0
> **Status:** ⏳ Pendente
> **Owner:** Unassigned
> **Estimativa:** 15h
> **Prioridade:** Crítica

---

## Descrição

Implementar camada de segurança de infraestrutura para proteção de secrets, tratamento seguro de erros, headers de segurança HTTP, e logging sem exposição de dados sensíveis. Corrige vulnerabilidades críticas identificadas na auditoria de segurança.

**Vulnerabilidades Corrigidas:**
- CRÍTICA: Secrets em texto plano no .env (MongoDB URI, OpenAI API Key, Telegram Token, SMTP password)
- CRÍTICA: Error disclosure - mensagens de erro expondo `str(e)` com detalhes internos
- MÉDIA: Headers de segurança ausentes (CSP, XSS, HSTS)
- MÉDIA: Logging expondo dados sensíveis (API keys, passwords)
- BAIXA: Docker rodando como root user

---

## Passos de Implementação

### 1. Código

#### Secrets Manager
- [ ] `src/security/__init__.py`: Criar módulo de segurança
- [ ] `src/security/secrets_manager.py`: Gerenciador de secrets
  - Suporte a environment variables (dev)
  - Suporte a AWS Secrets Manager (production)
  - Função `get_secret(key, default)` para acesso unificado
  - Função `mask_secret(value)` para logging seguro

#### Error Handler
- [ ] `src/security/error_handler.py`: Handler seguro de erros
  - Classe `SecureError` para exceções seguras
  - Função `create_error_response()` que não expõe detalhes internos
  - Códigos de erro mapeados (E001-E009)
  - Trace ID para correlação de logs
  - Handler global para FastAPI

#### Security Headers Middleware
- [ ] `src/middleware/security_headers.py`: Headers de segurança
  - Content-Security-Policy (CSP)
  - X-Content-Type-Options: nosniff
  - X-Frame-Options: DENY
  - X-XSS-Protection: 1; mode=block
  - Strict-Transport-Security (HSTS) em HTTPS
  - Referrer-Policy
  - Permissions-Policy

#### Secure Logging
- [ ] `src/utils/secure_logging.py`: Logging com mascaramento
  - `SensitiveDataFilter` para filtrar logs
  - Padrões para mascarar: API keys, passwords, tokens, URIs, CPF, cartões
  - Função `configure_secure_logging()` para setup global

#### Integrações
- [ ] `src/config.py`: Integrar secrets manager
- [ ] `src/api/routes.py`: Substituir `str(e)` por SecureError
- [ ] `src/api/ingest_routes.py`: Substituir `str(e)` por SecureError
- [ ] `src/api/telegram_routes.py`: Substituir `str(e)` por SecureError
- [ ] `src/api/company_routes.py`: Substituir `str(e)` por SecureError
- [ ] `main.py`: Adicionar SecurityHeadersMiddleware e exception handler

### 2. Testes

- [ ] `tests/test_infrastructure_security.py`:
  - `test_secrets_manager_masks_values`: Verifica mascaramento de secrets
  - `test_secrets_manager_fetches_from_env`: Verifica leitura de env vars
  - `test_error_handler_no_stack_trace`: Verifica que erros não expõem stack
  - `test_error_handler_includes_trace_id`: Verifica trace ID para debugging
  - `test_security_headers_csp`: Verifica header CSP presente
  - `test_security_headers_xss`: Verifica header X-XSS-Protection
  - `test_secure_logging_masks_api_keys`: Verifica mascaramento em logs
  - `test_secure_logging_masks_mongodb_uri`: Verifica mascaramento de URIs

### 3. Documentação

- [ ] `docs/SECURITY.md`: Guia de segurança do projeto
  - Seção sobre gerenciamento de secrets
  - Seção sobre tratamento de erros
  - Seção sobre headers de segurança
- [ ] `.env.example`: Documentar secrets obrigatórios com comentários

### 4. Infraestrutura

- [ ] `Dockerfile`: Adicionar usuário non-root
  ```dockerfile
  RUN addgroup --system --gid 1001 appgroup && \
      adduser --system --uid 1001 --gid 1001 appuser
  USER appuser
  ```
- [ ] `docker-compose.yml`: Remover valores padrão fracos de credenciais
- [ ] Opcional: Configurar AWS Secrets Manager para produção

---

## Código de Referência

### Secrets Manager
```python
class SecretsManager:
    def get_secret(self, key: str, default: Optional[str] = None) -> Optional[str]:
        if self.environment == "production":
            value = self._get_from_aws_secrets_manager(key)
            if value:
                return value
        return os.getenv(key, default)

    def mask_secret(self, value: str, show_chars: int = 4) -> str:
        if len(value) <= show_chars * 2:
            return "***"
        return f"{value[:show_chars]}...{value[-show_chars:]}"
```

### Error Handler
```python
ERROR_CODES = {
    "E001": "Internal server error",
    "E002": "Database connection error",
    "E003": "External service unavailable",
    "E004": "Invalid request format",
    "E005": "Authentication failed",
    "E006": "Authorization denied",
    "E007": "Resource not found",
    "E008": "Rate limit exceeded",
    "E009": "Validation error",
}

class SecureError(Exception):
    def __init__(self, code: str, message: Optional[str] = None, status_code: int = 500):
        self.code = code
        self.message = message or ERROR_CODES.get(code, "Unknown error")
        self.status_code = status_code
```

### Secure Logging Patterns
```python
SENSITIVE_PATTERNS = [
    (r'(api_key|apikey)["\s:=]+(["\']?)([a-zA-Z0-9_-]{20,})\2', r'\1=***MASKED***'),
    (r'(password|passwd|pwd)["\s:=]+(["\']?)([^\s"\']+)\2', r'\1=***MASKED***'),
    (r'(mongodb(\+srv)?://)[^:]+:[^@]+@', r'\1***:***@'),
    (r'\b\d{3}[.-]?\d{3}[.-]?\d{3}[.-]?\d{2}\b', '***CPF***'),
]
```

---

## Dependências

- Nenhuma feature depende desta
- Esta feature é base para: 036 (API Security), 037 (AI Guardrails)

---

## Ações Imediatas (URGENTE)

**Antes de implementar, execute manualmente:**
1. Revogar MongoDB URI exposta e criar nova
2. Revogar OpenAI API Key e gerar nova
3. Revogar Telegram Bot Token e criar novo bot/token
4. Alterar SMTP password
5. Verificar que `.env` está no `.gitignore`

---

## Notas de Expansão

- Rotação automática de secrets
- Integração com HashiCorp Vault
- Alertas de tentativa de acesso a secrets inválidos
- Audit log de acesso a secrets
- Criptografia de secrets em repouso

---

## Referências

- [OWASP Secure Coding Practices](https://owasp.org/www-project-secure-coding-practices-quick-reference-guide/)
- [AWS Secrets Manager](https://aws.amazon.com/secrets-manager/)
- [FastAPI Security](https://fastapi.tiangolo.com/tutorial/security/)
- [Security Headers](https://securityheaders.com/)
