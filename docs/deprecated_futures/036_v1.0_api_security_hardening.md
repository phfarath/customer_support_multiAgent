# API Security Hardening

> **Versão Target:** V1.0
> **Status:** ⏳ Pendente
> **Owner:** Unassigned
> **Estimativa:** 20h
> **Prioridade:** Crítica

---

## Descrição

Implementar hardening de segurança nas APIs do sistema, incluindo validação de JWT em produção, verificação de assinatura do webhook do Telegram, rate limiting avançado, e configuração segura de CORS. Corrige vulnerabilidades altas identificadas na auditoria de segurança.

**Vulnerabilidades Corrigidas:**
- CRÍTICA: JWT secret com valor padrão fraco ("CHANGE_THIS_IN_PRODUCTION")
- ALTA: Webhook do Telegram aceita requisições sem verificação de assinatura
- ALTA: Autenticação inconsistente no fluxo Telegram -> ingest_message
- ALTA: Rate limiting baseado apenas em IP (fácil contornar com proxies)
- ALTA: CORS permite localhost em produção

---

## Passos de Implementação

### 1. Código

#### JWT Validation
- [ ] `src/config.py`: Adicionar validação de produção
  - Adicionar campo `environment` (development/staging/production)
  - Validar que `jwt_secret_key` não é o valor padrão em produção
  - Validar comprimento mínimo de 32 caracteres
  - Adicionar campo `telegram_webhook_secret`

#### Telegram Webhook Signature
- [ ] `src/api/telegram_routes.py`: Implementar verificação de assinatura
  - Função `verify_telegram_signature(request)` usando `X-Telegram-Bot-Api-Secret-Token`
  - Bloquear requisições sem assinatura válida em produção
  - Adicionar logging de tentativas inválidas

#### Rate Limiting Avançado
- [ ] `src/middleware/rate_limiter.py`: Rate limiting por fingerprint
  - Gerar key única: IP + User-Agent hash + API Key prefix
  - Configurar limites diferenciados por tipo de operação
  - Suporte a Redis para rate limiting distribuído (opcional)

#### CORS Seguro
- [ ] `src/middleware/cors.py`: CORS com validação de produção
  - Filtrar localhost/127.0.0.1 em produção
  - Validar origins contra whitelist
  - Logging de origins rejeitadas

#### Integrações
- [ ] `main.py`: Registrar novos middlewares
- [ ] `docker-compose.yml`: Forçar uso de variáveis de ambiente para secrets
- [ ] `docker-compose.dev.yml`: Manter valores padrão apenas em dev

### 2. Testes

- [ ] `tests/test_api_security.py`:
  - `test_jwt_secret_validation_production`: Rejeita secret fraco em prod
  - `test_jwt_secret_minimum_length`: Rejeita secrets < 32 chars
  - `test_telegram_webhook_requires_signature`: Bloqueia sem assinatura
  - `test_telegram_webhook_rejects_invalid_signature`: Rejeita assinatura errada
  - `test_rate_limit_per_fingerprint`: Verifica fingerprinting funciona
  - `test_rate_limit_different_keys_independent`: Keys diferentes, limites separados
  - `test_cors_blocks_localhost_production`: Bloqueia localhost em prod
  - `test_cors_allows_whitelisted_origins`: Permite origins válidas

### 3. Documentação

- [ ] `docs/API_SECURITY.md`: Guia de segurança de APIs
  - Configuração de webhook do Telegram
  - Configuração de rate limiting
  - Configuração de CORS
- [ ] `.env.example`: Adicionar `TELEGRAM_WEBHOOK_SECRET` e `ENVIRONMENT`

### 4. Infraestrutura

- [ ] `docker-compose.yml`:
  - Remover valores padrão de `MONGO_ROOT_PASSWORD`
  - Usar syntax `${VAR:?error}` para variáveis obrigatórias
- [ ] Configurar webhook do Telegram com secret token

---

## Código de Referência

### JWT Validation (config.py)
```python
from pydantic import model_validator

class Settings(BaseSettings):
    environment: str = "development"
    jwt_secret_key: str = "CHANGE_THIS_IN_PRODUCTION"
    telegram_webhook_secret: Optional[str] = None

    @model_validator(mode='after')
    def validate_production_settings(self):
        if self.environment == "production":
            if self.jwt_secret_key == "CHANGE_THIS_IN_PRODUCTION":
                raise ValueError("JWT_SECRET_KEY must be changed in production")
            if len(self.jwt_secret_key) < 32:
                raise ValueError("JWT_SECRET_KEY must be at least 32 characters")
            if not self.telegram_webhook_secret:
                raise ValueError("TELEGRAM_WEBHOOK_SECRET required in production")
            if any("localhost" in o for o in self.cors_allowed_origins):
                raise ValueError("Localhost origins not allowed in production")
        return self
```

### Telegram Webhook Signature (telegram_routes.py)
```python
import hmac

async def verify_telegram_signature(request: Request) -> bool:
    """Verify Telegram webhook using secret token header"""
    if settings.environment != "production" and not settings.telegram_webhook_secret:
        return True  # Skip in dev if not configured

    secret_token = request.headers.get("X-Telegram-Bot-Api-Secret-Token")
    if not secret_token:
        logger.warning(f"Telegram webhook without signature from {request.client.host}")
        return False

    if not hmac.compare_digest(secret_token, settings.telegram_webhook_secret):
        logger.warning(f"Invalid Telegram signature from {request.client.host}")
        return False

    return True

@router.post("/webhook")
@limiter.limit("50/minute")
async def telegram_webhook(request: Request) -> Dict[str, Any]:
    if not await verify_telegram_signature(request):
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="Invalid webhook signature"
        )
    # ... rest of handler
```

### Rate Limiter (rate_limiter.py)
```python
import hashlib
from slowapi import Limiter
from slowapi.util import get_remote_address

def get_rate_limit_key(request: Request) -> str:
    """Generate rate limit key from IP + User-Agent + API Key"""
    ip = get_remote_address(request)
    user_agent = request.headers.get("User-Agent", "")[:50]
    api_key = request.headers.get("X-API-Key", "")[:10]

    fingerprint = hashlib.md5(f"{ip}:{user_agent}:{api_key}".encode()).hexdigest()
    return fingerprint

RATE_LIMITS = {
    "default": "60/minute",
    "ingest": "15/minute",
    "pipeline": "5/minute",
    "read": "120/minute",
    "admin": "5/minute",
    "webhook": "30/minute"
}
```

### CORS Middleware (cors.py)
```python
def get_cors_origins() -> list[str]:
    """Get CORS origins, filtering localhost in production"""
    origins = settings.cors_allowed_origins

    if settings.environment == "production":
        origins = [o for o in origins if "localhost" not in o and "127.0.0.1" not in o]
        if not origins:
            raise ValueError("No valid CORS origins for production")

    return origins
```

---

## Dependências

- **Depende de:** Feature 038 (Infrastructure Security) - para secrets manager
- **Bloqueia:** Nenhuma

---

## Configuração do Telegram Webhook

Para configurar o webhook do Telegram com secret token:

```bash
# Definir webhook com secret token
curl -X POST "https://api.telegram.org/bot<TOKEN>/setWebhook" \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://your-domain.com/telegram/webhook",
    "secret_token": "your-secret-token-here"
  }'
```

---

## Notas de Expansão

- Rate limiting por empresa/tenant
- Bloqueio automático de IPs suspeitos
- Integração com WAF (Web Application Firewall)
- Monitoramento de tentativas de ataque
- IP allowlist/denylist configurável

---

## Referências

- [Telegram Webhook Secret Token](https://core.telegram.org/bots/api#setwebhook)
- [OWASP API Security](https://owasp.org/www-project-api-security/)
- [SlowAPI Rate Limiting](https://slowapi.readthedocs.io/)
- [FastAPI CORS](https://fastapi.tiangolo.com/tutorial/cors/)
