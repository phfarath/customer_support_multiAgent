# Email Inbound Support

> **Versão Target:** V1.1
> **Status:** ⏳ Pendente
> **Owner:** Unassigned
> **Estimativa:** 18h

---

## Descrição

Suporte para recebimento de emails de clientes via IMAP/POP3 polling ou webhook (SendGrid/Mailgun), com parsing de email, tracking de threads e integração com o pipeline de mensagens.

---

## Passos de Implementação

### 1. Código

- [ ] `src/adapters/email_adapter.py` - Adapter principal (8h)
  - IMAP connection e polling
  - Email parsing (HTML/plain text, attachments)
  - Thread ID tracking via Message-ID/In-Reply-To
  - Envio de respostas via SMTP
- [ ] `src/api/email_routes.py` - Webhook endpoints (2h)
  - POST para receber emails via webhook (SendGrid/Mailgun)
- [ ] `src/models/email.py` - Modelos Pydantic (1h)
- [ ] `src/utils/email_parser.py` - Utilidades de parsing (2h)

### 2. Testes

- [ ] `tests/unit/test_email_adapter.py` - Unit tests (2h)
- [ ] `tests/unit/test_email_parser.py` - Parser tests (1h)
- [ ] `tests/integration/test_email_e2e.py` - E2E flow (2h)

### 3. Documentação

- [ ] `docs/EMAIL_SETUP.md` - Guia de configuração
  - IMAP/SMTP configuration
  - Webhook setup (SendGrid/Mailgun)
  - Environment variables

### 4. Infraestrutura

- [ ] Email inbox dedicado para suporte
- [ ] IMAP/SMTP credentials
- [ ] (Opcional) SendGrid/Mailgun account para webhooks
- [ ] Environment variables: `EMAIL_IMAP_*`, `EMAIL_SMTP_*`

---

## Dependências

- V1.0 deve estar completo

---

## Arquivos Novos

```
src/
├── adapters/
│   └── email_adapter.py       # NEW
├── api/
│   └── email_routes.py        # NEW
├── models/
│   └── email.py               # NEW
└── utils/
    └── email_parser.py        # NEW

docs/
└── EMAIL_SETUP.md             # NEW
```

---

## Decisões de Design

### Opção A: IMAP Polling
- **Pros:** Simples, funciona com qualquer provider
- **Cons:** Delay (polling interval), mais recursos

### Opção B: Webhook (SendGrid/Mailgun)
- **Pros:** Real-time, menos recursos
- **Cons:** Vendor lock-in, setup mais complexo

**Recomendação:** Começar com IMAP polling, migrar para webhook se necessário.

---

## Thread Tracking

```
Email Headers:
- Message-ID: <unique-id@domain>
- In-Reply-To: <parent-message-id@domain>
- References: <thread-messages@domain>

MongoDB:
- ticket.email_thread_id = Message-ID do primeiro email
- Novas mensagens linkadas via In-Reply-To/References
```

---

## Referências

- [imaplib Python docs](https://docs.python.org/3/library/imaplib.html)
- [email.parser Python docs](https://docs.python.org/3/library/email.parser.html)
- [SendGrid Inbound Parse](https://docs.sendgrid.com/for-developers/parsing-email/setting-up-the-inbound-parse-webhook)
