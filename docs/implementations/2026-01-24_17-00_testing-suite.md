# Testing Suite

> **Implementado em:** 2026-01-24 17:00
> **Status:** ✅ Production-ready

---

## Descrição

Implementação completa de suíte de testes automatizados com pytest, incluindo testes unitários para agents, routes e pipeline, testes de integração E2E para fluxo de ingestão, e cenários de teste com seeds para ambiente de teste.

---

## Arquivos Modificados/Criados

### Arquivos Criados

- `conftest.py` - Fixtures globais: fake_db, fake_openai_factory, FakeCollection, FakeCursor, FakeOpenAIClient
- `pytest.ini` - Configurações do pytest: asyncio_mode=auto, markers (unit, integration), testpaths=tests
- `tests/unit/test_agents.py` - Testes unitários dos 4 agents (triage, router, resolver, escalator) com fallback logic
- `tests/unit/test_routes.py` - Testes unitários dos endpoints REST: create_ticket, run_pipeline, get_ticket, list_tickets, ingest_message
- `tests/unit/test_pipeline.py` - Testes unitários do AgentPipeline: execução de todos agentes, erro quando ticket não encontrado
- `tests/integration/test_ingest_flow.py` - Teste de integração E2E para endpoint /api/ingest-message
- `tests/scenarios/__init__.py` - BaseTestCase para estrutura de testes de cenário
- `tests/scenarios/test_routing.py` - Testes de lógica de roteamento
- `tests/scenarios/test_sales.py` - Testes de persona de vendas e produtos
- `tests/scenarios/test_rag.py` - Testes de recuperação RAG de conhecimento
- `tests/scenarios/test_escalation.py` - Testes de lógica de escalonamento (determinísticos via fallback)
- `tests/seeds/reset_db.py` - Script para resetar todas as collections do banco
- `tests/seeds/seed_companies.py` - Script para seed companies e documentos RAG (manual_test.md)
- `tests/run_suite.py` - Master test runner para executar cenários sequencialmente

---

## Como Usar

### Rodar Todos os Testes (pytest)

```bash
pytest
```

### Rodar Apenas Unit Tests

```bash
pytest tests/unit/
```

### Rodar Apenas Integration Tests

```bash
pytest tests/integration/
```

### Rodar com Verbosidade

```bash
pytest -v
```

### Rodar Testes Específicos

```bash
pytest tests/unit/test_agents.py::test_triage_agent_fallback_saves_results -v
```

### Rodar Cenários de Teste (run_suite.py)

```bash
cd tests
python run_suite.py
```

### Resetar Banco de Testes

```bash
cd tests/seeds
python reset_db.py
```

### Seed de Dados de Teste

```bash
cd tests/seeds
python seed_companies.py
```

---

## Exemplos de Código

### Fixture fake_db

```python
@pytest.fixture
def fake_db(monkeypatch):
    collections = {
        COLLECTION_TICKETS: FakeCollection(),
        COLLECTION_INTERACTIONS: FakeCollection(),
        # ... outras collections
    }

    def _get_collection(name: str) -> FakeCollection:
        return collections[name]

    monkeypatch.setattr("src.database.get_collection", _get_collection)
    monkeypatch.setattr("src.agents.triage_agent.get_collection", _get_collection)
    # ... outros monkeypatches

    return collections
```

### Teste de Agent com Fallback

```python
@pytest.mark.asyncio
async def test_triage_agent_fallback_saves_results(fake_db, fake_openai_factory, monkeypatch):
    fake_client = fake_openai_factory(raise_on="json")
    monkeypatch.setattr("src.utils.openai_client.get_openai_client", lambda: fake_client)

    agent = TriageAgent()
    ticket = {"ticket_id": "T-1", "subject": "Quero cancelar", "description": "Urgente"}
    context = {"ticket": ticket, "interactions": []}

    result = await agent.execute("T-1", context)

    assert result.success is True
    assert result.decisions["priority"] == "P1"
    assert fake_db[COLLECTION_TICKETS].updated
```

### Teste de Route

```python
@pytest.mark.unit
def test_create_ticket_success(fake_db):
    app = build_app()
    client = TestClient(app)

    payload = {
        "ticket_id": "T-100",
        "customer_id": "C-1",
        "channel": "telegram",
        "subject": "Ajuda",
        "description": "Preciso de suporte",
        "company_id": "comp_001",
    }

    response = client.post("/api/tickets", json=payload)

    assert response.status_code == 201
    assert response.json()["success"] is True
    assert fake_db[COLLECTION_TICKETS].inserted
```

---

## Testes Realizados

### Unit Tests

**Agents (tests/unit/test_agents.py)**
- ✅ TriageAgent fallback salva resultados (priority P1 para urgência)
- ✅ RouterAgent fallback roteia por categoria
- ✅ ResolverAgent escalona e responde com fallback
- ✅ EscalatorAgent fallback escalona e atualiza ticket

**Routes (tests/unit/test_routes.py)**
- ✅ create_ticket success
- ✅ create_ticket company mismatch retorna 403
- ✅ run_pipeline retorna resultados
- ✅ get_ticket not found retorna 404
- ✅ list_tickets retorna count
- ✅ ingest_message success (não escalado)

**Pipeline (tests/unit/test_pipeline.py)**
- ✅ pipeline executa todos os agentes
- ✅ pipeline levanta erro quando ticket não encontrado

### Integration Tests

**Ingest Flow (tests/integration/test_ingest_flow.py)**
- ✅ ingest_message cria ticket e interações

### Scenarios

**Escalation (tests/scenarios/test_escalation.py)**
- ✅ Negative Sentiment -> Escalona
- ✅ Low Confidence -> Escalona
- ✅ Normal conditions -> Não escalona

---

## Troubleshooting

### Erro: "Module not found"

Certifique-se de estar na raiz do projeto e que o PYTHONPATH está configurado:
```bash
export PYTHONPATH="${PYTHONPATH}:$(pwd)"
```

### Erro: "asyncio_mode"

O pytest.ini já está configurado com `asyncio_mode = auto`. Se ocorrer erro, verifique se pytest-asyncio está instalado:
```bash
pip install pytest-asyncio
```

### Erro: "Mongo connection"

Os testes usam fake_db fixtures, não necessitam de MongoDB real. Se estiver rodando cenários (run_suite.py), certifique-se que MONGODB_URI está configurado no .env:
```
MONGODB_URI=mongodb://localhost:27017
```

### RAG Seed Falhando

Certifique-se de que OPENAI_API_KEY está configurado para ingestão de documentos RAG:
```bash
OPENAI_API_KEY=sk-...
```

---

## Referências

- [pytest documentation](https://docs.pytest.org/)
- [pytest-asyncio](https://pytest-asyncio.readthedocs.io/)
- [FastAPI Testing](https://fastapi.tiangolo.com/tutorial/testing/)
